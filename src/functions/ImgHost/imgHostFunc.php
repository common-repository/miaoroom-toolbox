<?php use MRTB\utils\Requests;require_once 'functions.php';require_once 'page.php';if(mrtb_get_option('image_host_wp_crop')){$enable=mrtb_get_option('image_host_wp_crop');function shapeSpace_disable_image_sizes($sizes){unset($sizes['thumbnail']);unset($sizes['medium']);unset($sizes['large']);unset($sizes['medium_large']);unset($sizes['1536x1536']);unset($sizes['2048x2048']);return $sizes;}add_action('intermediate_image_sizes_advanced','shapeSpace_disable_image_sizes');add_filter('big_image_size_threshold','__return_false');function shapeSpace_disable_other_image_sizes(){remove_image_size('post-thumbnail');remove_image_size('another-size');}add_action('init','shapeSpace_disable_other_image_sizes');update_option('thumbnail_size_w',$enable?0:225);update_option('thumbnail_size_h',$enable?0:150);update_option('thumbnail_crop',$enable?0:1);update_option('medium_size_w',$enable?0:375);update_option('medium_size_h',$enable?0:250);update_option('large_size_w',$enable?0:960);update_option('large_size_h',$enable?0:640);$oss_upload_options=get_option('ouop');$oss_upload_options['oss_webp']='0';update_option('ouop',$oss_upload_options);}function mr_install_img_host_table(){global $wpdb;include_once(ABSPATH.'/wp-admin/includes/upgrade.php');$table_charset='';$prefix=$wpdb->prefix;$img_host_table=$prefix.'mrtb_img_host';if($wpdb->has_cap('collation')){if(!empty($wpdb->charset)){$table_charset="DEFAULT CHARACTER SET $wpdb->charset";}if(!empty($wpdb->collate)){$table_charset.=" COLLATE $wpdb->collate";}}$create_img_host_sql="CREATE TABLE $img_host_table (id bigint(20) auto_increment NOT NULL,post_id bigint(20) NOT NULL DEFAULT 0,host_type varchar(10) NOT NULL,raw_url varchar(255) NOT NULL,host_url varchar(255) NOT NULL,create_time datetime NOT NULL default '0000-00-00 00:00:00',`update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,PRIMARY KEY (id));";maybe_create_table($img_host_table,$create_img_host_sql);}add_action('admin_init','mr_install_img_host_table');if(defined('OSS_ACCESS_ID')){remove_filter('wp_get_attachment_url','oss_upload_attachment_url',9999,2);remove_filter('wp_calculate_image_srcset','oss_upload_image_srcset',9999,5);}if(wp_get_theme()['Name']=='B2'||wp_get_theme()['Name']=='B2子主题'){add_filter('b2_thumb_no_local','replace_attachment_url',9999,2);add_action('wp_print_scripts',function(){wp_dequeue_script('jquery.lazyload');},100);}add_filter('the_content','replace',1);function replace($content){if(!is_singular(mrtb_get_option('image_host_post_type'))){return $content;}if(img_host_cache_get_option('post_image_host_switch'.get_the_ID())){$need_replace=img_host_cache_get_option('post_image_host_switch'.get_the_ID());}else{$need_replace=get_post_meta(get_the_ID(),'post_image_host_switch',true);img_host_cache_set_option('post_image_host_switch'.get_the_ID(),$need_replace);}if($need_replace){$with_a='/<a.*?href="([^"]+)".*?<img.*?src="([^"]+)"/';$without_a='/<img.*?src="([^"]+)"/';$replaced=preg_replace_callback($without_a,function($mx){$host_url=strpos($mx[1],'/wp-content')!==0?mrtb_get_host_url($mx[1],null):mrtb_get_host_url(get_site_url().$mx[1],null);if($mx[1]!=mrtb_is_host_url($mx[1])){return str_replace($mx[1],$host_url,$mx[0]);}return $mx[0];},$content);if(preg_match($with_a,$content)){$replaced=preg_replace_callback($with_a,function($mx){$host_url=strpos($mx[1],'/wp-content')!==0?mrtb_get_host_url($mx[1],null):mrtb_get_host_url(get_site_url().$mx[1],null);if($mx[1]!=mrtb_is_host_url($mx[1])){return $mx[1]!==$mx[2]?str_replace($mx[1],$host_url,$mx[0]):$mx[0];}return $mx[0];},$replaced);}return $replaced;}return $content;}function replace_attachment_url($raw_url,$post_id){return mrtb_get_host_url($raw_url,$post_id);}if(mrtb_get_option('image_host_thumb')){if(!wp_get_theme()['Name']=='B2'&&!wp_get_theme()['Name']=='B2子主题'||is_admin()){add_filter('wp_get_attachment_url','replace_attachment_url',9999,2);add_filter('wp_get_attachment_metadata','mrtb_img_host_attachment_metadata',10000,2);}function mrtb_img_host_attachment_metadata($data,$id){foreach($data['sizes']as $k=>$v){if(!isset($v['file'])){continue;}unset($data['sizes']);}return $data;}}if(mrtb_get_option('image_host_front_thumb')){add_filter('wp_get_attachment_image_src','replace_post_thumb',9999,2);function replace_post_thumb($image,$attachment_id){$image[0]=$image[0]?mrtb_get_host_url($image[0]):$image[0];return $image;}}function post_info(){$check_time=get_option('mrtb_tsp');$ip=get_option('mrtb_ip');$time_diff=\MRTB\utils\Date::Diff($check_time,time(),'h');if($ip&&$check_time&&$time_diff<=3){return;}if(!$ip||!filter_var($ip,FILTER_VALIDATE_IP)||$time_diff>8){$response=@Requests::getAsync('https://api.ipify.org?format=json')->then(function($res){$ip=@json_decode($res->getBody()->getContents())->ip;return $ip;});$ip=$response->wait();}$response=@Requests::postAsync('https://api.miaoroom.com/wp-json/mr/api/v1/user/register',array('http_errors'=>false,'verify'=>false,'connect_timeout'=>30,'timeout'=>30,'curl.options'=>['CURLOPT_VERIFYPEER'=>false,],'query'=>array('ip'=>$ip,'url'=>get_option('siteurl'),'product'=>'喵容工具箱',)))->then(function($res){return@$res->getBody()->getContents();});$json=$response->wait();$jsonObj=json_decode(json_decode($json));if(!isset($json)||!isset($jsonObj->data)){return;}if($jsonObj->data){update_option('mrtb_tsp',time());update_option('mrtb_ip',$ip);}}add_action('admin_init','post_info');